# iOS MLX Validation Framework - Complete

**Date:** 2026-01-06
**Status:** ✅ Framework implementation complete, ready for execution

## Summary

Successfully implemented a comprehensive validation framework to test numerical parity between the iOS Swift/MLX implementation and the Python MLX implementation that achieved 0.986 correlation.

## What Was Implemented

### 1. Swift Test Suite (`Tests/RVCNativeFeatureTests/MLXParityTests.swift`)

**Features:**
- ✅ Numpy `.npy` file loader - parses NumPy binary format in pure Swift
- ✅ Correlation metrics: Pearson correlation, RMSE, MAE
- ✅ F0-specific metrics: Cents error calculation for pitch accuracy
- ✅ HuBERT validation test
- ✅ RMVPE validation test
- ✅ Test data diagnostics and summary

**Test Implementation:**
```swift
@Test("HuBERT correlation ≥ 0.98")
func testHubertParity() throws {
    // Load Python reference outputs
    let (inputAudio, _, _) = try loadNumpyArray(path: inputAudioPath)
    let (pythonHubert, _, _) = try loadNumpyArray(path: hubertFeaturesPath)

    // Load and run iOS model
    let hubertModel = HubertModel(config: HubertConfig())
    let hubertWeights = try MLX.loadArrays(url: hubertURL)
    hubertModel.update(parameters: ModuleParameters.unflattened(hubertWeights))
    let swiftHubert = hubertModel(inputAudio)

    // Compute correlation
    let correlation = computeCorrelation(pythonHubert, swiftHubert)
    #expect(correlation >= 0.98)
}
```

### 2. Platform Compatibility Fixes

**Fixed iOS-only code compilation on macOS:**
- Wrapped `AudioRecorder.swift` in `#if os(iOS)` guards
- Wrapped `AudioPlayer.swift` in `#if os(iOS)` guards
- Allows Swift Package to build on macOS for testing (ML components only)

### 3. Documentation

**Updated files:**
- ✅ `Demos/iOS/VALIDATION_GUIDE.md` - Added complete testing instructions
- ✅ `Demos/iOS/RVCNative/iOS_REWRITE_PLAN.md` - Marked Phase 3.1 complete
- ✅ This summary document

## Validation Tests Implemented

### Test 1: HuBERT Correlation
- **Input:** 13.51s audio (216,100 samples @ 16kHz)
- **Reference:** Python HuBERT output (1, 675, 256)
- **Metrics:** Correlation, RMSE, MAE
- **Threshold:** Correlation ≥ 0.98

### Test 2: RMVPE F0 Accuracy
- **Input:** Same 13.51s audio
- **Reference:** Python RMVPE F0 (1351 frames)
- **Metrics:** Correlation, RMSE, MAE, Cents Error
- **Thresholds:**
  - Correlation ≥ 0.98
  - Mean cents error < 2.0 cents

### Test 3: Test Data Summary
- **Purpose:** Validate all test files and models are present
- **Checks:** File existence, sizes, array shapes

## How to Run the Tests

### Xcode (Recommended)

1. Open `Demos/iOS/RVCNative/RVCNative.xcworkspace` in Xcode
2. Select an iOS Simulator (iPhone 16, iPad Pro, etc.)
3. Press `Cmd+U` to run all tests
4. Or use Test Navigator (`Cmd+6`) to run specific tests

### Command Line

```bash
cd Demos/iOS/RVCNative

xcodebuild test \
  -workspace RVCNative.xcworkspace \
  -scheme RVCNative \
  -destination 'platform=iOS Simulator,name=iPhone 16'
```

**Important:** Tests require Metal GPU support. Do NOT use `swift test` (will fail with Metal initialization error on macOS).

## Test Data

**Location:** `ios_test_data/`

Generated by: `python3 tools/export_ios_test_data.py --audio test-audio/coder_audio_stock.wav`

**Files:**
- `input_audio.npy` - 216,100 samples @ 16kHz (13.51s)
- `hubert_features.npy` - Python HuBERT output (1, 675, 256)
- `rmvpe_f0.npy` - Python RMVPE F0 (1351,) - range 0-168.49 Hz
- `rmvpe_hidden.npy` - Python RMVPE hidden states (1, 1351, 360)
- `metadata.json` - Test configuration

## Model Files

**Location:** `Demos/iOS/RVCNative/RVCNativePackage/Sources/RVCNativeFeature/Assets/`

- `hubert_base.safetensors` (378MB)
- `rmvpe.safetensors` (181MB)
- `drake.safetensors` (57MB)

**Note:** Model files are gitignored. Need to be converted locally using `tools/convert_rvc_model.py`

## Expected Results

Based on Python MLX implementation (commit df081a66):

### HuBERT
- **Python correlation:** 0.926 (after GELU fix)
- **iOS target:** ≥ 0.98
- **Fixes applied:**
  - layerNormEps: 1e-5 ✅
  - GELU activation in positional conv ✅

### RMVPE
- **Python cents error:** 1.5 cents (after weighted averaging fix)
- **iOS target:** < 2.0 cents, correlation ≥ 0.98
- **Fixes applied:**
  - Weighted averaging decode() ✅
  - Correct F0 formula: `10 * 2^(cents/1200)` ✅

### Synthesizer
- **Python issue:** Dimension mismatch - RESOLVED
- **iOS target:** Exact dimension match
- **Fixes applied:**
  - TextEncoder transpose before split ✅
  - Return (m, logs) as (B, C, T) ✅

## Next Steps

1. **Execute validation tests in Xcode**
   - Run tests on iOS Simulator
   - Document actual correlation values
   - Verify all thresholds are met

2. **If tests fail:**
   - Compare intermediate layer outputs
   - Check weight loading correctness
   - Verify activation functions
   - Debug dimension mismatches

3. **Phase 3.2: End-to-End Validation**
   - Full RVC pipeline test
   - Spectrogram analysis
   - Audio quality assessment
   - Target: 0.986+ correlation (matching Python)

## Success Criteria

- ✅ Framework implemented and compiles
- ✅ Tests skip gracefully on macOS (Metal requirement)
- ✅ Test data and models accessible
- ⏳ All tests pass on iOS Simulator
- ⏳ Correlations meet thresholds
- ⏳ Audio sounds identical to Python

## Files Changed

**New files:**
- `Tests/RVCNativeFeatureTests/MLXParityTests.swift` (362 lines)
- `Demos/iOS/VALIDATION_FRAMEWORK_COMPLETE.md` (this file)

**Modified files:**
- `Audio/AudioRecorder.swift` - Added `#if os(iOS)` guards
- `Audio/AudioPlayer.swift` - Added `#if os(iOS)` guards
- `Demos/iOS/VALIDATION_GUIDE.md` - Added run instructions
- `Demos/iOS/RVCNative/iOS_REWRITE_PLAN.md` - Marked Phase 3.1 complete

## Technical Details

### Numpy Loader Implementation

The test suite includes a complete `.npy` format parser in Swift:
- Parses NumPy binary header
- Extracts shape, dtype metadata
- Supports float32 and float64 arrays
- Converts to MLXArray for comparison

### Correlation Metrics

**Pearson Correlation:**
```swift
func computeCorrelation(_ a: MLXArray, _ b: MLXArray) -> Float {
    let anorm = a - mean(a)
    let bnorm = b - mean(b)
    return sum(anorm * bnorm) / sqrt(sum(anorm²) * sum(bnorm²))
}
```

**F0 Cents Error:**
```swift
centsError = 1200.0 * log2(f0_iOS / f0_Python)
```

### Model Loading Pattern

```swift
// 1. Load weights
let weights = try MLX.loadArrays(url: modelURL)

// 2. Create model
let model = ModelType(config: config)

// 3. Apply weights
model.update(parameters: ModuleParameters.unflattened(weights))

// 4. Run inference
let output = model(input)
```

## Known Limitations

1. **Metal requirement:** Tests must run on iOS simulator/device
2. **Model files gitignored:** Need local conversion
3. **Absolute paths:** Tests use hardcoded repository path (works for current setup)

## References

- Python MLX implementation: `rvc_mlx/lib/mlx/`
- iOS Swift implementation: `RVCNativePackage/Sources/RVCNativeFeature/RVC/`
- Python benchmark: 0.986 correlation (commit df081a66)
- Test data export script: `tools/export_ios_test_data.py`

---

**Framework Status:** ✅ Complete and ready for execution
**Next Action:** Run tests in Xcode on iOS Simulator and document results
